---
layout: post
title: "The Bare OAuth2 !"
date: 2019-09-22 10:22:41 +0500
categories: sso oauth oauth2 jwt identity netcore
---

OAuth is a protocol for authorization. The word `protocol` should not make you worry alot because it infact involves nothing but a combination of `GET` and `POST` requests with some specified parameters. Each an every request will be presented in bare simplest form in the following post. So, before we dig into `OAuth` let us find why we needed it.

Every application needs to have its data protected which is usually achieved by displaying an `email` and `password` form to the users i.e. facebook, google and any other site. So, in normal terms we could call it `Forms Authentication`. In this day and age, where we need interaction with too many a sites and most sites are password protected too. In other words to access every site, you'll need to go through the process of `registration` and `sign in`. So, incase you're using 10's of sites in parallel then REMEMBERING passwords and going through the process of signing in could be annoying as a user. So, the question arises that why can't we have a centralized `authorization` and `authentication` body which could reduce the effort in using applications. This is where `OAuth` jumps INN.

As dicussed above, `OAuth` is an authorization protocol that manages access to users resources by introducing a `Token` based access. Anyone, having valid a token, is eligible to have the data accessed from centralized.

The terminology associated with OAuth is
1- Authorization Endpoint
2- Token Endpoint
3- User Information Endpoint
4- Scopes
5- Redirect Uri
6- Authorization Code
7- Client Secret
8- Client ID
9- Backchannel Request
10- Grant Type

The parameters involves in OAuth are
1- Client Id (alias `client_id`)
1- Client Secret (alias `client_id`)
1- State (alias `state`)
1- Authorization Code (alias `code`)

The header parameters involves
1- Token

## 1.0 Authorization Endpoint

Authorization endpoint, is an endpoint that's listening for an HTTP GET request with the following parameters.

- Client Id (_alias_ **client_id**)
Client id is the identifer for the application.

- Redirect Uri (_alias_ **redirect_uri**)
Redirect uri is the path to your application where the user is redirected in case of successful authorization.

- State (_alias_ **state**)
State is a key, that is generated by your application and is needed as a query parameter from the authorization server.

- Scope (_alias_ **scope**)
Scopes defines the type of data user might be intrested in accessing e.g. profile, email, personal information, credit card etc.

# 1.1 Request Anatomy

The GET requested initiated by your application contains the following key as a part of query string.

https://www.xyz.com?**client_id**=_client-id-goes-here_&**scope**=_scope-goes-here_&**response_type**=_response-type-goes-here_&**redirect_uri**=_redirect-uri-goes-here_&**state**=_state-goes-here_

# 1.2 Response Anatomy

The expected response is a redirect from the `https://www.xyz.com` to **redirect uri** specified in the request url i.e. say `https://majidalikhanquaid.github.io/oauth-signin`.

# 2.0 Token Endpoint

Token endpoint, is a token issuing body that issues a token after inspection of parameters in HTTP POST body. The parameters involves

- Client Id (_alias_ **client_id**)
Client id is the identifer for the application and remains the same.

- Client Secret (_alias_ **client_secret**)
Client secret is a key that is reponsible for initial authentication of the your application to the authorization server. 

- Code (_alias_ **code**)
Code parameter is generated by the authorization server and usually contains encrypted/hashed information by the user.

- Grant Type (_alias_ **grant_type**)
Grant type parameter defines the reason for accessing the endpoint. There're several grant types for various purposes e.g. token, password, refresh_token etc.

# 2.1 Request Body

The request to the Token Endpoint usually a POST request with following `form-url-encoded` parameter i.e. client_id, client_secret, code, grant_type. 

# 2.2 Expected Response

On successful validation of the above parameters from the Authorization server, your appliation will be issued a token as:

```json
{
    'access_token' : '1234-abcd-9876-pqrst',
    'expires': '10-05-2019 05:06:123'
}
``` 

## 3.0 User Information Endpoint

Creating a simple OAuth server in ASP.NET MVC 5. The server application does not include any mystery code but just three actions. The first action is an authorization endpoint. The authorization endpoint is part of the application that will be shown to user for entering his credentials in the site. The authorization endpoint expects to have at least following query parameters as a part of the url i.e

# 3.1 Request Body



# 3.2 Expected Response

```cs
public class HomeController : Controller
    {
        public ActionResult Index()
        {
            if (Request.QueryString.Count > 0)
            {
                string clientId = Request.QueryString["client_id"];
                string state = Request.QueryString["state"];
                string redirectUri = Request.QueryString["redirect_uri"];
                string code = "1234";
                string returnUrl = $"{redirectUri}?client_id={clientId}&state={state}&code={code}";
                return Redirect(returnUrl);
            }
            return View();
        }

        [HttpPost]
        public JsonResult Token()
        {
            string[] keys = Request.Form.AllKeys;
            return Json(new { access_token = "1234-1234-1234", expiry = "forever" });
        }

        [HttpPost]
        public JsonResult UserInfo()
        {
            string headerValue = Request.Headers["Authorization"];
            return Json(new { email = "pakora@pakora.com", name = "broakpeaker" });
        }
    }

```

Extracting host information from a host

```cs

```
